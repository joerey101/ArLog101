generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------

enum Rol {
  ADMIN     @map("admin")
  EMPRESA   @map("empresa")
  CANDIDATO @map("candidato")
}

enum Modalidad {
  PRESENCIAL @map("presencial")
  REMOTO     @map("remoto")
  HIBRIDO    @map("hibrido")
}

enum EstadoAnuncio {
  PENDIENTE @map("pendiente")
  ACTIVO    @map("activo")
  PAUSADO   @map("pausado")
  RECHAZADO @map("rechazado")
  CERRADO   @map("cerrado")
  BORRADOR  @map("borrador")
}

enum EstadoPostulacion {
  NUEVO       @map("nuevo")
  VISTO       @map("visto")
  ENTREVISTA  @map("entrevista")
  FINALISTA   @map("finalista")
  DESCARTADO  @map("descartado")
  CONTRATADO  @map("contratado")
}

enum TipoEtiqueta {
  HARD_SKILL      @map("hard_skill")
  SOFT_SKILL      @map("soft_skill")
  IDIOMA          @map("idioma")
  CERTIFICACION   @map("certificacion")
  DOCUMENTACION   @map("documentacion")
}

enum NivelEtiqueta {
  BASICO      @map("basico")
  INTERMEDIO  @map("intermedio")
  AVANZADO    @map("avanzado")
  EXPERTO     @map("experto")
}

// -----------------------------------------------------------------------------
// MODELOS PRINCIPALES
// -----------------------------------------------------------------------------

model Usuario {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password_hash String
  rol           Rol       @default(CANDIDATO)
  fecha_registro DateTime @default(now())

  // Relaciones
  perfilCandidato PerfilCandidato?
  perfilEmpresa   PerfilEmpresa?
  anuncios        Anuncio[]
  postulaciones   Postulacion[]

  @@map("usuarios")
}

model PerfilEmpresa {
  id            Int     @id @default(autoincrement())
  usuario_id    Int     @unique
  razon_social  String?
  rubro         String?
  descripcion   String? @db.Text
  sitio_web     String?
  logo_url      String?
  cuit          String? // Identificación Fiscal
  
  // Ubicación
  ubicacion     String?

  usuario       Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  
  // Relación inversa para facilitar querys desde Anuncio
  anuncios      Anuncio[] 

  @@map("perfiles_empresa")
}

model PerfilCandidato {
  id              Int     @id @default(autoincrement())
  usuario_id      Int     @unique
  nombre          String?
  apellido        String?
  telefono        String?
  foto_url        String? // [NEW] Foto de perfil (Cloudinary)
  titulo_cargo    String? // Ej: Desarrollador Fullstack
  sobre_mi        String? @db.Text
  cv_url          String?
  linkedin_url    String?
  portfolio_url   String?
  
  // Ubicación
  pais            String? @default("Argentina")
  provincia       String?
  ciudad          String?

  usuario         Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  etiquetas       PerfilEtiqueta[]

  @@map("perfiles_candidato")
}

model Anuncio {
  id                Int           @id @default(autoincrement())
  usuario_id        Int
  
  // Datos del Puesto
  titulo            String
  descripcion       String        @db.Text
  departamento      String?       // Área
  
  // Detalles
  modalidad         Modalidad     @default(PRESENCIAL)
  tipo_contrato     String?       // Full-time, Part-time, etc.
  rango_salarial    String?       // Texto libre o JSON rango
  ubicacion         String?       // Lugar físico del trabajo
  
  // Estado y Fechas
  estado            EstadoAnuncio @default(ACTIVO)
  fecha_publicacion DateTime      @default(now())
  fecha_actualizacion DateTime    @updatedAt

  // Relaciones
  usuario           Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  // Relacion explícita opcional con empresa para facilitar includes
  empresa_perfil    PerfilEmpresa? @relation(fields: [usuario_id], references: [usuario_id], map: "anuncios_empresa_fk")

  postulaciones     Postulacion[]
  etiquetas         AnuncioEtiqueta[]

  @@map("anuncios")
}

model Postulacion {
  id                Int               @id @default(autoincrement())
  anuncio_id        Int
  candidato_id      Int
  
  fecha_postulacion DateTime          @default(now())
  estado            EstadoPostulacion @default(NUEVO)
  
  // Datos snapshot del momento de postulación
  cv_snapshot_url   String?
  mensaje_candidato String?           @db.Text
  match_score       Int?              @default(0) // IA Score

  anuncio           Anuncio           @relation(fields: [anuncio_id], references: [id], onDelete: Cascade)
  candidato         Usuario           @relation(fields: [candidato_id], references: [id], onDelete: Cascade)

  @@unique([anuncio_id, candidato_id]) // Evitar doble postulación
  @@map("postulaciones")
}

// -----------------------------------------------------------------------------
// SISTEMA DE ETIQUETAS (Skills)
// -----------------------------------------------------------------------------

model Etiqueta {
  id              Int             @id @default(autoincrement())
  nombre          String          @unique
  categoria       TipoEtiqueta?

  perfiles        PerfilEtiqueta[]
  anuncios        AnuncioEtiqueta[]

  @@map("etiquetas")
}

model PerfilEtiqueta {
  perfil_id       Int
  etiqueta_id     Int
  nivel           NivelEtiqueta   @default(INTERMEDIO)

  perfil          PerfilCandidato @relation(fields: [perfil_id], references: [id], onDelete: Cascade)
  etiqueta        Etiqueta        @relation(fields: [etiqueta_id], references: [id], onDelete: Cascade)

  @@id([perfil_id, etiqueta_id])
  @@map("perfil_etiquetas")
}

model AnuncioEtiqueta {
  anuncio_id      Int
  etiqueta_id     Int
  obligatorio     Boolean         @default(false)

  anuncio         Anuncio         @relation(fields: [anuncio_id], references: [id], onDelete: Cascade)
  etiqueta        Etiqueta        @relation(fields: [etiqueta_id], references: [id], onDelete: Cascade)

  @@id([anuncio_id, etiqueta_id])
  @@map("anuncio_etiquetas")
}
